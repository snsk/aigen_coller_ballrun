# 3. ゲーム概要

- 3D空間に傾斜レールとテーブル、画面手前に分割された仕分け箱を配置。
- ボールはスポーン後、物理エンジンでレール→テーブル→仕分け箱へ転がる。
- プレイヤーはマウスで仕分け箱（全体）を左右に平行移動。
- ボールが各区画のトリガーVolumeに入った瞬間に色判定。

# 4. ルール/スコア

- 正解: +10点（コンボ倍率 1.0 → 1.2 → 1.5 → 2.0、ミスで 1.0 にリセット）。
- 間違い: -5点 または ライフ -1（モード選択）。
- 画面外へ落下: ミス。
- モード: クラシック（ライフ）、タイムアタック（60秒）、エンドレス。

# 5. 3Dシーン仕様（初期値例）

- 座標系: 右手系、Y↑。
- スケール: 単位 = 1m。
- レール: 長さ 1.6m、幅 0.22m、傾斜 18°、摩擦 0.4、反発 0.1。
- テーブル: 1.8m × 0.9m、高さ 0.75m、摩擦 0.5。
- 仕分け箱（親）: 幅 0.8m、奥行 0.28m、高さ 0.18m、位置 Y=0.60m、手前端に配置。
- 区画: 等幅（各 0.2m）、色: 赤・緑・黄・青。
- 区画トリガー: 底面に薄い Trigger Box（0.2m × 0.28m × 0.02m）。
- ボール: 直径 0.09m、質量 0.12kg、摩擦 0.35、反発 0.2、角減衰 0.02。
- スポーン: レール上端の中央 ±0.07m、初速 0、角速度 0。
- 境界: テーブル周縁に低いエッジ（0.01m）—現実感と暴走抑制。

# 6. 物理仕様

- エンジン: 連続衝突判定（CCD）有効、固定タイムステップ dt=1/120s。
- 重力: (0, -9.81, 0)。
- ソルバ反復: 位置 8 / 速度 2。
- マテリアル: レール・テーブル・箱で摩擦・反発を段階設定。
- スリープ: 静止 > 1.5s で睡眠、再衝突でウェイク。
- Trigger: 区画底面のみセンサー（質量・衝突はせず接触イベントのみ）。
- 同時計算: 最大アクティブ球 30 個、超過はキュー待機。

# 7. 入力/操作

- マウス→ワールド: カメラ正面に平行な不可視の操作平面（Y=0.60m）へレイキャストし、交点Xを取得。
- 仕分け箱のXを lerp(currentX, targetX, 1 - exp(-k*dt)) で平滑移動（例: k=16）。
- クランプ: レーン範囲 ±0.7m。
- クリック不要。ウィンドウ外で自動PAUSE。

# 8. スポーン難易度

- 生成間隔: Start 1.0s → Wave毎 -10%（下限 0.35s）。
- 同時出現: 1 → 2（Wave5）→ 3（Wave10）。
- 色確率: 均等 25%、同色連続禁止。
- 乱数: シード固定（リプレイ用）。

# 9. ステート/フロー

- BOOT → MENU → COUNTDOWN(3→1) → PLAY ↔ PAUSE → RESULT。

# 10. 判定ロジック

- 物理エンジンの接触イベントで、Ball が Trigger(区画カラー) に侵入。
- 一致: Ball.color === Trigger.color → スコア加算 & コンボ更新、ボールをデタッチ→フェードアウト。
- 不一致: 減点/ライフ減少、同様に削除。
- テーブル外 または 10秒以上詰まり: ミスとして削除。

# 11. データモデル（概略）

```ts
type Color = 'red' | 'green' | 'yellow' | 'blue';

interface Ball {
  id: number;
  color: Color;
  body: RigidBody;     // 物理ボディ
  collider: Collider;  // 球
  state: 'active' | 'scored' | 'missed';
  spawnAt: number;
}

interface SortingBox {
  root: Object3D;
  rb: KinematicBody; // キネマティックで移動のみ
  segments: { color: Color; trigger: Collider /* sensor */ }[];
}
```

# 12. カメラ/描画

- カメラ: パース 50–60°、やや俯瞰、被写界深度なし。
- ライティング: HDRI 1枚 + 直射灯（影オフ or ソフト）。
- ポスト（任意）: 軽いブルームのみ。
- 背景: 単色 or グラデ。

# 13. UI

- 上部HUD: スコア、コンボ、ライフ/残り時間。
- メニュー: モード、音量、難易度、リプレイ（シード表示）。
- リザルト: 総スコア、正解率、最大コンボ。

# 14. パフォーマンス方針

- 物理を Rapier(WASM) で実行、固定dtで積分。
- ボールはオブジェクトプールで再利用。
- 静的メッシュ（床/レール/テーブル）は単一コライダに結合。
- 描画はインスタンシング（ボール材質共有）。
- 60fps未満が数秒継続 → レンダー解像度 0.8x に自動調整。

# 15. テレメトリ保存

- localStorage: ベストスコア、設定。
- デバッグHUD（開発時のみ）: 物理FPS、アクティブ剛体数、衝突件数。

# 16. テスト/受入

- 物理一貫性: 落下開始→仕分け箱到達まで平均 2.2–3.0s（±10%）。
- 入力遅延: ポインタ→箱追従の95パーセンタイル ≤ 90ms。
- 判定: 正解/不正解のユニットテスト（Trigger侵入で一回のみ加算）。
- 負荷: 同時ボール30個で60秒、フレーム落ち < 5%・エラー無し。

# 技術スタック / アーキテクチャ

- コア: Three.js（WebGL）、Rapier 3D（WASM物理・キネマティック/センサー対応）、TypeScript 5.x。
- ツール: Vite（開発/ビルド）、Vitest（テスト）、ESLint + Prettier。
- 代替: Cannon-es（JSのみ・学習容易）/ Ammo.js（Bullet移植・高精度）。本仕様では Rapier を採用。
- 補助: postprocessing（任意・最小限）、stats-gl（開発用FPS表示、リリースでは無効）。

# ディレクトリ例

```
/src
  /app          // エントリ, GameLoop, 状態遷移
  /scene        // Three初期化, 照明, カメラ
  /physics      // Rapierワールド, マテリアル, 衝突購読
  /entities     // Ball, SortingBox, Rail, Table
  /systems      // Spawner, Scoring, InputRaycaster, Effects
  /ui           // HUD/メニュー
/assets         // glTF/テクスチャ（SEは任意）
```

# 主要モジュール

- GameLoop: RAFで描画、accumulatorで dt=1/120 物理ステップ。
- InputRaycaster: スクリーン座標→操作平面交点。
- XSortingBoxSystem: キネマティック剛体を targetX へイージング移動。
- CollisionBus: Rapierのイベントを購読→ score()/miss()。
- Spawner: Wave制御・色抽選・オブジェクトプール。

# デプロイ

- GitHub Actions → GitHub Pages / Cloudflare Pages（静的配信）。

